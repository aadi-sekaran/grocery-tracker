<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aadi & Krithika - Grocery Tracker</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .akg-wrap { max-width: 1100px; margin: 28px auto; background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .akg-header h2 { margin: 0 0 6px 0; font-size: 1.8rem; color: #3d3d5c; text-align: center; }
        .akg-header p { color: #666; text-align: center; margin-bottom: 20px; }
        .akg-form-card, .akg-filter-card, .akg-table-card { background: #fff; border: 1px solid #eef; border-radius: 10px; padding: 20px; margin: 16px 0; }
        .akg-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .akg-row label { font-weight: 600; color: #444; min-width: 120px; }
        .akg-row input, .akg-row select { flex-grow: 1; padding: 9px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem; min-width: 180px; }
        .akg-shares { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .akg-shares > div { display: flex; flex-direction: column; }
        .akg-shares label { margin-bottom: 5px; }
        .akg-actions { margin-top: 20px; }
        .akg-btn { background: #f4f5ff; border: 1px solid #e1e4ff; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; }
        .akg-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .akg-btn-primary { background: linear-gradient(90deg,#667eea,#764ba2); color: #fff; border: none; }
        .akg-form-msg, .loading-indicator { margin-left: 15px; font-weight: 600; }
        .akg-table-wrap { overflow-x: auto; }
        .akg-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .akg-table th, .akg-table td { text-align: left; padding: 12px 10px; border-bottom: 1px solid #f2f2f6; }
        .akg-table th { background: #f7f8ff; font-size: 1rem; }
        .akg-table tbody tr:hover { background: #fafbff; }
        .akg-totals-row td { font-weight: 700; background: #f9f9fb; font-size: 1.05rem; }
        .akg-delete-btn { background: #ff4d6d; color: #fff; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="akg-wrap" class="akg-wrap">
        <header class="akg-header">
            <h2>ðŸ›’ Aadi & Krithika â€” Grocery Tracker (â‚¬)</h2>
            <p>Add grocery bills and track monthly totals. Data is saved online in a Google Sheet.</p>
        </header>

        <section class="akg-form-card">
            <h3>Add New Entry</h3>
            <form id="akg-entry-form">
                <div class="akg-row"><label>Date</label><input type="date" id="akg-date" required /></div>
                <div class="akg-row"><label>Supermarket</label><input type="text" id="akg-supermarket" placeholder="e.g. Lidl, Tesco, Aldi" required /></div>
                <div class="akg-row"><label>Who paid</label><select id="akg-paid-by"><option value="Aadi">Aadi</option><option value="Krithika">Krithika</option></select></div>
                <div class="akg-row"><label>Total amount (â‚¬)</label><input type="number" id="akg-total" step="0.01" min="0" placeholder="25.50" required /></div>
                <div class="akg-shares">
                    <div><label>Aadi's share (â‚¬)</label><input type="number" id="akg-aadi-share" step="0.01" min="0" value="0" required /></div>
                    <div><label>Krithika's share (â‚¬)</label><input type="number" id="akg-krithika-share" step="0.01" min="0" value="0" required /></div>
                    <div><label>Common share (â‚¬)</label><input type="number" id="akg-common-share" step="0.01" min="0" value="0" required /></div>
                </div>
                <div class="akg-row akg-actions">
                    <button type="submit" class="akg-btn akg-btn-primary">Save Entry</button>
                    <div id="akg-form-msg" class="akg-form-msg"></div>
                </div>
            </form>
        </section>

        <section class="akg-filter-card">
            <div class="akg-row"><label>Filter by:</label><select id="akg-filter-month"></select><select id="akg-filter-year"></select></div>
        </section>

        <section class="akg-table-card">
            <h3>Entries <span class="loading-indicator" id="loading-indicator"></span></h3>
            <div class="akg-table-wrap">
                <table id="akg-entries-table" class="akg-table">
                    <thead><tr><th>Date</th><th>Supermarket</th><th>Paid By</th><th>Total (â‚¬)</th><th>Aadi (â‚¬)</th><th>Krithika (â‚¬)</th><th>Common (â‚¬)</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                    <tfoot><tr class="akg-totals-row"><td colspan="3"><strong>Totals</strong></td><td id="akg-total-grand">â‚¬0.00</td><td id="akg-total-aadi">â‚¬0.00</td><td id="akg-total-krithika">â‚¬0.00</td><td id="akg-total-common">â‚¬0.00</td><td></td></tr></tfoot>
                </table>
            </div>
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- THIS LINE IS NOW CORRECT ---
        const SHEETDB_API_URL = 'https://sheetdb.io/api/v1/nzi4y82hdzs9v'; 

        const form = document.getElementById('akg-entry-form');
        const monthFilter = document.getElementById('akg-filter-month');
        const yearFilter = document.getElementById('akg-filter-year');
        const tableBody = document.querySelector('#akg-entries-table tbody');
        const msgDiv = document.getElementById('akg-form-msg');
        const loadingIndicator = document.getElementById('loading-indicator');

        const formatEuro = (value) => 'â‚¬' + parseFloat(value || 0).toFixed(2);
        const showMsg = (message, isError = false) => {
            msgDiv.textContent = message;
            msgDiv.style.color = isError ? '#b00020' : '#0b7a4d';
            setTimeout(() => msgDiv.textContent = '', 4000);
        };

        async function fetchAndRenderEntries() {
            loadingIndicator.textContent = '(Loading...)';
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Fetching entries...</td></tr>';
            
            try {
                const response = await fetch(`${SHEETDB_API_URL}?sort_by=date&sort_order=asc`);
                if (!response.ok) throw new Error('Network response was not ok.');
                const allEntries = await response.json();

                renderTable(allEntries);
            } catch (error) {
                console.error("Fetch error:", error);
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Could not load data. Check your API URL and Google Sheet permissions.</td></tr>';
            } finally {
                loadingIndicator.textContent = '';
            }
        }

        function renderTable(entries) {
            const selectedMonth = parseInt(monthFilter.value);
            const selectedYear = parseInt(yearFilter.value);

            const filteredEntries = entries.filter(entry => {
                if (!entry.date) return false; // Skip rows without a date
                const entryDate = new Date(entry.date);
                if (isNaN(entryDate.getTime())) return false; // Skip invalid dates
                
                const yearMatch = entryDate.getFullYear() === selectedYear;
                const monthMatch = selectedMonth === 0 || (entryDate.getMonth() + 1) === selectedMonth;
                return yearMatch && monthMatch;
            });

            tableBody.innerHTML = '';
            let grandTotal = 0, aadiTotal = 0, krithikaTotal = 0, commonTotal = 0;

            if (filteredEntries.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No entries for this period.</td></tr>';
            } else {
                filteredEntries.forEach(entry => {
                    grandTotal += parseFloat(entry.total || 0);
                    aadiTotal += parseFloat(entry.aadiShare || 0);
                    krithikaTotal += parseFloat(entry.krithikaShare || 0);
                    commonTotal += parseFloat(entry.commonShare || 0);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${entry.date || ''}</td>
                        <td>${entry.supermarket || ''}</td>
                        <td>${entry.paidBy || ''}</td>
                        <td>${formatEuro(entry.total)}</td>
                        <td>${formatEuro(entry.aadiShare)}</td>
                        <td>${formatEuro(entry.krithikaShare)}</td>
                        <td>${formatEuro(entry.commonShare)}</td>
                        <td><button class="akg-delete-btn" data-id="${entry.id}">Delete</button></td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            document.getElementById('akg-total-grand').textContent = formatEuro(grandTotal);
            document.getElementById('akg-total-aadi').textContent = formatEuro(aadiTotal);
            document.getElementById('akg-total-krithika').textContent = formatEuro(krithikaTotal);
            document.getElementById('akg-total-common').textContent = formatEuro(commonTotal);
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';

            const newEntry = {
                id: Date.now(),
                date: document.getElementById('akg-date').value,
                supermarket: document.getElementById('akg-supermarket').value,
                paidBy: document.getElementById('akg-paid-by').value,
                total: document.getElementById('akg-total').value,
                aadiShare: document.getElementById('akg-aadi-share').value,
                krithikaShare: document.getElementById('akg-krithika-share').value,
                commonShare: document.getElementById('akg-common-share').value,
            };

            try {
                const response = await fetch(SHEETDB_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: [newEntry] }),
                });
                if (!response.ok) throw new Error('Failed to save entry.');
                
                showMsg('Entry saved successfully!', false);
                form.reset();
                document.getElementById('akg-date').valueAsDate = new Date();
                fetchAndRenderEntries();
            } catch (error) {
                showMsg('Error: Could not save entry.', true);
                console.error(error);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Save Entry';
            }
        });

        tableBody.addEventListener('click', async function(e) {
            if (e.target.classList.contains('akg-delete-btn')) {
                if (!confirm('Are you sure you want to delete this entry?')) return;

                const entryId = e.target.dataset.id;
                e.target.disabled = true;
                e.target.textContent = '...';

                try {
                    const response = await fetch(`${SHEETDB_API_URL}/id/${entryId}`, {
                        method: 'DELETE',
                    });
                    if (!response.ok) throw new Error('Failed to delete entry.');
                    
                    showMsg('Entry deleted.', false);
                    fetchAndRenderEntries();
                } catch (error) {
                    showMsg('Error: Could not delete entry.', true);
                    console.error(error);
                    e.target.disabled = false;
                    e.target.textContent = 'Delete';
                }
            }
        });
        
        monthFilter.addEventListener('change', fetchAndRenderEntries);
        yearFilter.addEventListener('change', fetchAndRenderEntries);

        function init() {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthFilter.innerHTML = '<option value="0">All Months</option>';
            months.forEach((month, index) => monthFilter.innerHTML += `<option value="${index + 1}">${month}</option>`);
            
            const currentYear = new Date().getFullYear();
            for (let i = currentYear + 1; i >= currentYear - 5; i--) yearFilter.innerHTML += `<option value="${i}">${i}</option>`;
            
            monthFilter.value = new Date().getMonth() + 1;
            yearFilter.value = currentYear;
            document.getElementById('akg-date').valueAsDate = new Date();
            
            fetchAndRenderEntries();
        }

        init();
    });
    </script>
</body>
</html>
