<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Night Fury & Light Fury - Grocery Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .akg-wrap { max-width: 1100px; margin: 28px auto; background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .akg-header h2 { margin: 0 0 20px 0; font-size: 1.8rem; color: #3d3d5c; text-align: center; }
        .akg-form-card, .akg-filter-card, .akg-table-card, .akg-chart-card { background: #fff; border: 1px solid #eef; border-radius: 10px; padding: 20px; margin: 16px 0; }
        .akg-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .akg-row label { font-weight: 600; color: #444; min-width: 120px; }
        .akg-row input, .akg-row select { flex-grow: 1; padding: 9px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem; min-width: 180px; }
        .akg-shares { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .akg-shares > div { display: flex; flex-direction: column; }
        .akg-shares label { margin-bottom: 5px; }
        .akg-actions { margin-top: 20px; }
        .akg-btn { background: #f4f5ff; border: 1px solid #e1e4ff; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; }
        .akg-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .akg-btn-primary { background: linear-gradient(90deg,#667eea,#764ba2); color: #fff; border: none; }
        .akg-form-msg, .loading-indicator { margin-left: 15px; font-weight: 600; }
        .akg-table-wrap { overflow-x: auto; }
        .akg-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .akg-table th, .akg-table td { text-align: left; padding: 12px 10px; border-bottom: 1px solid #f2f2f6; }
        .akg-table th { background: #f7f8ff; font-size: 1rem; }
        .akg-table tbody tr:hover { background: #fafbff; }
        .akg-totals-row td { font-weight: 700; background: #f9f9fb; font-size: 1.05rem; }
        .akg-delete-btn { background: #ff4d6d; color: #fff; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .akg-chart-container { position: relative; height: 300px; width: 100%; max-width: 600px; margin: 20px auto 0 auto; }
    </style>
</head>
<body>

    <div id="akg-wrap" class="akg-wrap">
        <header class="akg-header">
            <h2>ðŸ›’ Night Fury & Light Fury â€” Grocery Tracker (â‚¬)</h2>
        </header>

        <section class="akg-form-card">
            <h3>Add New Entry</h3>
            <form id="akg-entry-form">
                <div class="akg-row"><label>Date</label><input type="date" id="akg-date" required /></div>
                <div class="akg-row"><label>Supermarket</label>
                    <select id="akg-supermarket" required>
                        <option value="Aldi">Aldi</option>
                        <option value="Lidl">Lidl</option>
                        <option value="Tesco">Tesco</option>
                        <option value="Dunnes">Dunnes</option>
                        <option value="SPAR">SPAR</option>
                        <option value="SuperValu">SuperValu</option>
                        <option value="Indian Store">Indian Store</option>
                        <option value="Asian Store">Asian Store</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="akg-row"><label>Who paid</label><select id="akg-paid-by"><option value="Night Fury">Night Fury</option><option value="Light Fury">Light Fury</option></select></div>
                <div class="akg-row"><label>Total amount (â‚¬)</label><input type="number" id="akg-total" step="0.01" min="0" placeholder="25.50" required /></div>
                <div class="akg-shares">
                    <div><label>Night Fury's share (â‚¬)</label><input type="number" id="akg-nightFury-share" step="0.01" min="0" value="0" required /></div>
                    <div><label>Light Fury's share (â‚¬)</label><input type="number" id="akg-lightFury-share" step="0.01" min="0" value="0" required /></div>
                    <div><label>Common share (â‚¬)</label><input type="number" id="akg-common-share" step="0.01" min="0" value="0" required /></div>
                </div>
                <div class="akg-row akg-actions">
                    <button type="submit" class="akg-btn akg-btn-primary">Save Entry</button>
                    <div id="akg-form-msg" class="akg-form-msg"></div>
                </div>
            </form>
        </section>

        <section class="akg-filter-card">
            <div class="akg-row"><label>Filter by:</label><select id="akg-filter-month"></select><select id="akg-filter-year"></select></div>
        </section>

        <section class="akg-table-card">
            <h3>Entries <span class="loading-indicator" id="loading-indicator"></span></h3>
            <div class="akg-table-wrap">
                <table id="akg-entries-table" class="akg-table">
                    <thead><tr><th>Date</th><th>Supermarket</th><th>Paid By</th><th>Total (â‚¬)</th><th>Night Fury (â‚¬)</th><th>Light Fury (â‚¬)</th><th>Common (â‚¬)</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                    <tfoot><tr class="akg-totals-row"><td colspan="3"><strong>Totals (Personal + 1/2 Common)</strong></td><td id="akg-total-grand">â‚¬0.00</td><td id="akg-total-nightFury">â‚¬0.00</td><td id="akg-total-lightFury">â‚¬0.00</td><td id="akg-total-common">â‚¬0.00</td><td></td></tr></tfoot>
                </table>
            </div>
        </section>

        <section class="akg-chart-card">
            <h3>Monthly Totals Graph</h3>
            <div class="akg-chart-container">
                <canvas id="monthlyTotalsChart"></canvas>
            </div>
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const SHEETDB_API_URL = 'https://sheetdb.io/api/v1/nzi4y82hdzs9v'; 
        let monthlyChart;

        const form = document.getElementById('akg-entry-form');
        const monthFilter = document.getElementById('akg-filter-month');
        const yearFilter = document.getElementById('akg-filter-year');
        const tableBody = document.querySelector('#akg-entries-table tbody');
        const msgDiv = document.getElementById('akg-form-msg');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- SAFARI FIX: HELPER FUNCTION TO PARSE DATES RELIABLY ---
        function parseDateString(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            // Split the 'YYYY-MM-DD' string to avoid timezone issues
            const parts = dateStr.split('-');
            if (parts.length !== 3) return null;
            // new Date(year, monthIndex, day) is the most reliable format
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }

        const formatEuro = (value) => 'â‚¬' + parseFloat(value || 0).toFixed(2);
        const showMsg = (message, isError = false) => {
            msgDiv.textContent = message;
            msgDiv.style.color = isError ? '#b00020' : '#0b7a4d';
            setTimeout(() => msgDiv.textContent = '', 4000);
        };

        async function fetchAndRenderEntries() {
            loadingIndicator.textContent = '(Loading...)';
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Fetching entries...</td></tr>';
            
            try {
                const response = await fetch(`${SHEETDB_API_URL}?sort_by=date&sort_order=asc`);
                if (!response.ok) throw new Error('Network response was not ok.');
                const allEntries = await response.json();
                renderTable(allEntries);
            } catch (error) {
                console.error("Fetch error:", error);
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Could not load data. Check API URL and Google Sheet permissions.</td></tr>';
            } finally {
                loadingIndicator.textContent = '';
            }
        }

        function renderTable(entries) {
            const selectedMonth = parseInt(monthFilter.value);
            const selectedYear = parseInt(yearFilter.value);

            const filteredEntries = entries.filter(entry => {
                // --- SAFARI FIX: Use the new helper function here ---
                const entryDate = parseDateString(entry.date);
                if (!entryDate) return false;
                
                const yearMatch = entryDate.getFullYear() === selectedYear;
                const monthMatch = selectedMonth === 0 || (entryDate.getMonth() + 1) === selectedMonth;
                return yearMatch && monthMatch;
            });

            tableBody.innerHTML = '';
            let grandTotal = 0, nightFuryTotal = 0, lightFuryTotal = 0, commonTotal = 0;

            if (filteredEntries.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No entries for this period.</td></tr>';
            } else {
                filteredEntries.forEach(entry => {
                    grandTotal += parseFloat(entry.total || 0);
                    nightFuryTotal += parseFloat(entry.nightFuryShare || 0);
                    lightFuryTotal += parseFloat(entry.lightFuryShare || 0);
                    commonTotal += parseFloat(entry.commonShare || 0);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${entry.date || ''}</td>
                        <td>${entry.supermarket || ''}</td>
                        <td>${entry.paidBy || ''}</td>
                        <td>${formatEuro(entry.total)}</td>
                        <td>${formatEuro(entry.nightFuryShare)}</td>
                        <td>${formatEuro(entry.lightFuryShare)}</td>
                        <td>${formatEuro(entry.commonShare)}</td>
                        <td><button class="akg-delete-btn" data-id="${entry.id}">Delete</button></td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            const nightFuryFinalTotal = nightFuryTotal + (commonTotal / 2);
            const lightFuryFinalTotal = lightFuryTotal + (commonTotal / 2);

            document.getElementById('akg-total-grand').textContent = formatEuro(grandTotal);
            document.getElementById('akg-total-nightFury').textContent = formatEuro(nightFuryFinalTotal);
            document.getElementById('akg-total-lightFury').textContent = formatEuro(lightFuryFinalTotal);
            document.getElementById('akg-total-common').textContent = formatEuro(commonTotal);

            updateChart(nightFuryFinalTotal, lightFuryFinalTotal);
        }

        function updateChart(nightFuryData, lightFuryData) {
            const ctx = document.getElementById('monthlyTotalsChart').getContext('2d');
            
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Night Fury', 'Light Fury'],
                    datasets: [{
                        label: 'Total Monthly Spend',
                        data: [nightFuryData, lightFuryData],
                        backgroundColor: [ 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)' ],
                        borderColor: [ 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)' ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: (value) => 'â‚¬' + value } } },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Final Monthly Totals (including common share)' }
                    }
                }
            });
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const total = parseFloat(document.getElementById('akg-total').value) || 0;
            const nightFuryShare = parseFloat(document.getElementById('akg-nightFury-share').value) || 0;
            const lightFuryShare = parseFloat(document.getElementById('akg-lightFury-share').value) || 0;
            const commonShare = parseFloat(document.getElementById('akg-common-share').value) || 0;
            
            if (Math.abs((nightFuryShare + lightFuryShare + commonShare) - total) > 0.01) {
                showMsg('Error: The shares do not add up to the total amount. Please check the numbers.', true);
                return;
            }

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';

            const newEntry = {
                id: Date.now(),
                date: document.getElementById('akg-date').value,
                supermarket: document.getElementById('akg-supermarket').value,
                paidBy: document.getElementById('akg-paid-by').value,
                total: total,
                nightFuryShare: nightFuryShare,
                lightFuryShare: lightFuryShare,
                commonShare: commonShare,
            };

            try {
                const response = await fetch(SHEETDB_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: [newEntry] }),
                });
                if (!response.ok) throw new Error('Failed to save entry.');
                
                showMsg('Entry saved successfully!', false);
                form.reset();
                document.getElementById('akg-date').valueAsDate = new Date();
                fetchAndRenderEntries();
            } catch (error) {
                showMsg('Error: Could not save entry.', true);
                console.error(error);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Save Entry';
            }
        });

        tableBody.addEventListener('click', async function(e) {
            if (e.target.classList.contains('akg-delete-btn')) {
                if (!confirm('Are you sure you want to delete this entry?')) return;

                const entryId = e.target.dataset.id;
                e.target.disabled = true;
                e.target.textContent = '...';

                try {
                    const response = await fetch(`${SHEETDB_API_URL}/id/${entryId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Failed to delete entry.');
                    
                    showMsg('Entry deleted.', false);
                    fetchAndRenderEntries();
                } catch (error) {
                    showMsg('Error: Could not delete entry.', true);
                    console.error(error);
                    e.target.disabled = false;
                    e.target.textContent = 'Delete';
                }
            }
        });
        
        monthFilter.addEventListener('change', fetchAndRenderEntries);
        yearFilter.addEventListener('change', fetchAndRenderEntries);

        function init() {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthFilter.innerHTML = '<option value="0">All Months</option>';
            months.forEach((month, index) => monthFilter.innerHTML += `<option value="${index + 1}">${month}</option>`);
            
            const currentYear = new Date().getFullYear();
            for (let i = currentYear + 1; i >= currentYear - 5; i--) yearFilter.innerHTML += `<option value="${i}">${i}</option>`;
            
            monthFilter.value = new Date().getMonth() + 1;
            yearFilter.value = currentYear;
            document.getElementById('akg-date').valueAsDate = new Date();
            
            fetchAndRenderEntries();
        }

        init();
    });
    </script>
</body>
</html>
